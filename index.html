<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <title>Proyector CPO – UBA Derecho</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background: #fafafa; }
    h1 { margin: 0 0 8px; }
    .muted { color: #666; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, minmax(0, 1fr)); }
    .grid > * { min-width: 0; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; background: #fff; }
    .col6 { grid-column: span 6; } .col12 { grid-column: span 12; } .col4 { grid-column: span 4; } .col3{grid-column:span 3;} .col2{grid-column:span 2;} .col9 { grid-column: span 9; }
    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    input, select, button { width: 100%; max-width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { cursor: pointer; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; border-bottom: 1px solid #eee; padding: 10px 8px; vertical-align: top; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ddd; margin-right: 6px; margin-top: 6px; }
    .ok { border-color: #9be7a1; background: #f0fff2; }
    .warn { border-color: #ffd089; background: #fff8ee; }
    .bad { border-color: #ff9a9a; background: #fff1f1; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; min-width: 0; }
    .small { font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    @media (max-width: 900px) { .col6, .col4, .col3, .col2, .col9 { grid-column: span 12; } }
  </style>
</head>
<body>
  <div class="container">

<div id="authGate" class="card" style="max-width:560px; margin: 24px auto; display:none;">
  <h2 style="margin-top:0;">Ingresar</h2>
  <div class="muted small" style="margin-bottom:10px;">
    Creá tu usuario o iniciá sesión. La contraseña se guarda como <b>hash</b> (no en texto plano).
  </div>

  <label>Usuario</label>
  <input id="authUser" autocomplete="username" />

  <label>Contraseña</label>
  <input id="authPass" type="password" autocomplete="current-password" />

  <div class="row" style="margin-top:12px;">
    <button id="btnLogin">Entrar</button>
    <button id="btnRegister" type="button">Crear cuenta</button>
  </div>

  <div id="authMsg" class="small" style="margin-top:10px;"></div>
  <div class="muted small" style="margin-top:10px;">
    Reglas: mínimo 8, 1 mayúscula, 1 número, solo letras/números.
  </div>
</div>

<div id="appRoot" style="display:none;">
  <div class="row" style="align-items:flex-end; margin-bottom: 8px;">
    <div>
      <h1 style="margin:0;">Proyector CPO – UBA Derecho</h1>
      <div class="muted small">Proyecto en progreso.</div>
    </div>
    <div style="max-width:260px;">
      <div class="muted small">Sesión</div>
      <div id="whoami" class="mono small"></div>
      <button id="btnLogout" style="margin-top:6px;">Salir</button>
    </div>
  </div>

  <div class="grid" style="margin-top:16px;">
    <div class="card col9">
      <h3 style="margin-top:0;">Perfil</h3>

      <label>Plan</label>
      <select id="plan"></select>

      <label>Orientación</label>
      <select id="orientacion"></select>

      <h4 style="margin:14px 0 6px;">Materias</h4>
      <div class="muted small">Mové materias entre <b>Pendientes</b> y <b>Aprobadas</b>.</div>

      <div class="grid" style="margin-top:10px;">
        <div class="card col12" style="padding:12px;">
          <b>CPC</b>
          <div class="grid" style="grid-template-columns: 1fr auto 1fr; gap: 10px; margin-top:10px; align-items:center;">
            <div>
              <label class="small">Pendientes</label>
              <select id="cpc_pending" multiple size="10"></select>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <button type="button" id="cpc_to_approved" title="Marcar aprobadas">→</button>
              <button type="button" id="cpc_to_pending" title="Volver a pendientes">←</button>
            </div>
            <div>
              <label class="small">Aprobadas</label>
              <select id="cpc_approved" multiple size="10"></select>
            </div>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-button:10px;">
        <div class="card col12" style="padding:12px;">
          <b>CPO</b>
          <div class="grid" style="grid-template-columns: 1fr auto 1fr; gap: 10px; margin-top:10px; align-items:center;">
            <div>
              <label class="small">Pendientes</label>
              <select id="cpo_pending" multiple size="10"></select>
            </div>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <button type="button" id="cpo_to_approved" title="Marcar aprobadas">→</button>
              <button type="button" id="cpo_to_pending" title="Volver a pendientes">←</button>
            </div>
            <div>
              <label class="small">Aprobadas</label>
              <select id="cpo_approved" multiple size="10"></select>
            </div>
          </div>
        </div>
      </div>

      <label>Puntos ya aprobados (si tenés de antes y no querés cargarlos 1x1)</label>
      <input id="puntosPrevios" type="number" min="0" max="200" />

      <div class="row" style="margin-top:12px;">
        <button id="save">Guardar</button>
        <button id="reset" title="Borra solo los datos guardados en este navegador">Reset</button>
      </div>

      <div class="muted small" style="margin-top:10px;">
      </div>
    </div>

    <div class="card col3">
      <h3 style="margin-top:0;">Panel</h3>
      <div id="panel"></div>
      <hr style="border:none;border-top:1px solid #eee;margin:14px 0;">
      <div class="muted small" id="rulesBox"></div>
    </div>

    <div class="card col12">
      <h3 style="margin-top:0;">Buscador + sugerencias de cursada</h3>

      <div class="grid">
        <div class="col4">
          <label>Buscar materia</label>
          <input id="q" placeholder="Ej: daños, consumidor, crimin..." />
        </div>
        <div class="col3">
          <label>Depto</label>
          <select id="f_depto">
            <option value="">(Todos)</option>
            <option value="privado">Privado</option>
            <option value="penal">Penal</option>
            <option value="laboral">Laboral</option>
            <option value="publico">Público</option>
            <option value="empresarial">Económico/Empresarial</option>
            <option value="tributario">Tributario</option>
            <option value="procesal">Procesal</option>
            <option value="filosofia">Filosofía</option>
            <option value="sociales">Sociales</option>
            <option value="notarial">Notarial</option>
          </select>
        </div>
        <div class="col3">
          <label>Tipo</label>
          <select id="f_tipo">
            <option value="">(Todos)</option>
            <option value="mensual">Mensual</option>
            <option value="bimestral">Bimestral</option>
            <option value="cuatrimestral">Cuatrimestral</option>
          </select>
        </div>
        <div class="col2">
          <label>Puntos</label>
          <select id="f_pts">
            <option value="">(Todos)</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="4">4</option>
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card col6" style="padding:12px;">
          <div class="row">
            <div>
              <b>Planificar cuatrimestre</b>
              <div class="muted small">Carrito sugerido (máx. 16 pts / sin repetir áreas).</div>
            </div>
            <button id="btnSuggest">Generar sugerencia</button>
          </div>
          <div id="planBox" style="margin-top:10px;"></div>
        </div>

        <div class="card col6" style="padding:12px;">
          <b>Resultado del buscador</b>
          <div class="muted small">Hacé click en “Agregar a plan”.</div>
          <div id="resultCount" class="muted small" style="margin-top:6px;"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Materia</th>
            <th>Depto</th>
            <th>Tipo</th>
            <th>Pts</th>
            <th>Área</th>
            <th>Correlativas</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="catalogRows"></tbody>
      </table>
    </div>
  </div>
  © Julian y Caro
</div>

<script type="module">
  import { registerUser, loginUser, listMaterias, loadProgress, saveProgress } from "./auth.js";

  const KEY = "cpo_proyector_v2";
  const SESSION_KEY = "cpo_session_user";
  const ORIENTACIONES = [
    { id: "privado", nombre: "Derecho Privado" },
    { id: "penal", nombre: "Derecho Penal" },
    { id: "laboral", nombre: "Derecho Laboral" },
    { id: "int_publico", nombre: "Derecho Internacional Público" },
    { id: "administrativo", nombre: "Derecho Administrativo" },
    { id: "tributario", nombre: "Derecho Tributario" },
    { id: "empresarial", nombre: "Derecho Empresarial" },
    { id: "notarial", nombre: "Derecho Notarial" }
  ];

  let DB = null;
  let PLAN = [];
  let MAT_SHEET = []; // materias desde Google Sheets (materia_id, materia, instancia_id)

  function setSession(username, usuario_id) { localStorage.setItem(SESSION_KEY, JSON.stringify({ username, usuario_id, ts: Date.now() })); }
  function getSession() { const raw = localStorage.getItem(SESSION_KEY); return raw ? JSON.parse(raw) : null; }
  function clearSession() { localStorage.removeItem(SESSION_KEY); }

  function loadState() {
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : { plan:"2008", orientacion:"penal", puntosPrevios:0, aprobadas:[], aprobadas_cpc:[], aprobadas_cpo:[] };
  }
  function saveState(state) { localStorage.setItem(KEY, JSON.stringify(state)); }

  function esc(s) { return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
  function pointsByType(t) { return (DB?.rules?.points?.[t]) ?? (t === "mensual" ? 1 : t === "bimestral" ? 2 : 4); }

  function normalizeState(state) {
    state.aprobadas_cpc = Array.isArray(state.aprobadas_cpc) ? state.aprobadas_cpc.map(Number) : [];
    state.aprobadas_cpo = Array.isArray(state.aprobadas_cpo) ? state.aprobadas_cpo.map(Number) : [];
    return state;
  }

  function byInstancia(id) {
    return MAT_SHEET.filter(m => Number(m.instancia_id) === Number(id));
  }

  function renderSelectOptions(selectEl, items) {
    selectEl.innerHTML = items.map(m => `<option value="${m.materia_id}">${esc(m.materia)}</option>`).join("");
  }

  function selectedValues(selectEl) {
    return Array.from(selectEl.selectedOptions).map(o => Number(o.value));
  }

  function moveSelected(srcSel, dstSel) {
    const srcVals = new Set(selectedValues(srcSel));
    if (!srcVals.size) return;
    const dstVals = new Set(Array.from(dstSel.options).map(o => Number(o.value)));

    // mover manteniendo orden por nombre
    for (const o of Array.from(srcSel.options)) {
      const val = Number(o.value);
      if (srcVals.has(val)) {
        dstVals.add(val);
        srcSel.removeChild(o);
      }
    }

    // reconstruir dst ordenado por label
    const dstMap = new Map();
    for (const o of Array.from(dstSel.options)) dstMap.set(Number(o.value), o.textContent);
    for (const val of dstVals) {
      if (!dstMap.has(val)) {
        // buscar label en MAT_SHEET
        const m = MAT_SHEET.find(x => Number(x.materia_id) === val);
        dstMap.set(val, m ? m.materia : String(val));
      }
    }
    const dstItems = Array.from(dstMap.entries()).map(([materia_id, materia]) => ({ materia_id, materia }))
      .sort((a,b) => a.materia.localeCompare(b.materia, 'es'));
    renderSelectOptions(dstSel, dstItems);

    // reconstruir src también por label
    const srcItems = Array.from(srcSel.options).map(o => ({ materia_id: Number(o.value), materia: o.textContent }))
      .sort((a,b)=>a.materia.localeCompare(b.materia,'es'));
    renderSelectOptions(srcSel, srcItems);
  }

  function wireDualList(instanceId, pendingId, approvedId, toApprovedBtnId, toPendingBtnId, stateKey) {
    const pendingSel = document.getElementById(pendingId);
    const approvedSel = document.getElementById(approvedId);

    const all = byInstancia(instanceId);
    const approvedIds = new Set((loadState()[stateKey] || []).map(Number));
    const approved = all.filter(m => approvedIds.has(Number(m.materia_id))).sort((a,b)=>a.materia.localeCompare(b.materia,'es'));
    const pending = all.filter(m => !approvedIds.has(Number(m.materia_id))).sort((a,b)=>a.materia.localeCompare(b.materia,'es'));

    renderSelectOptions(pendingSel, pending);
    renderSelectOptions(approvedSel, approved);

    document.getElementById(toApprovedBtnId).onclick = () => moveSelected(pendingSel, approvedSel);
    document.getElementById(toPendingBtnId).onclick = () => moveSelected(approvedSel, pendingSel);

    // doble click
    pendingSel.ondblclick = () => moveSelected(pendingSel, approvedSel);
    approvedSel.ondblclick = () => moveSelected(approvedSel, pendingSel);
  }

  function readDualListsIntoState(state) {
    state.aprobadas_cpc = Array.from(document.getElementById("cpc_approved").options).map(o => Number(o.value));
    state.aprobadas_cpo = Array.from(document.getElementById("cpo_approved").options).map(o => Number(o.value));
    // derivadas para reglas/panel
    state.blancas = state.aprobadas_cpc.length;
    state.negritas = state.aprobadas_cpo.length;
    return state;
  }

  function evalMateriaEligibility(state, materia, approvedSet, plannedAreaSet) {
    const reasons = [];
    if (materia.plan && !materia.plan.includes(state.plan)) reasons.push("No corresponde al plan");
    const minBl = DB.rules.eligibility.start_points_min_blancas ?? 12;
    const extraMinBl = materia.extra_requirements?.min_blancas ?? null;
    const requiredBlancas = extraMinBl ?? minBl;
    if (state.blancas < requiredBlancas) reasons.push(`Faltan blancas (mín. ${requiredBlancas})`);
    const prereq = materia.prerequisites || [];
    const missing = prereq.filter(id => !approvedSet.has(id));
    if (missing.length) reasons.push(`Faltan correlativas (${missing.length})`);
    if (materia.area && plannedAreaSet.has(materia.area.toLowerCase())) reasons.push("Área repetida (en el plan)");
    return { ok: reasons.length === 0, reasons };
  }

  function renderSelectors(state) {
    document.getElementById("plan").innerHTML = (DB?.plans || ["2004","2008"]).map(p => `<option value="${p}" ${p===state.plan?"selected":""}>Plan ${p}</option>`).join("");
    document.getElementById("orientacion").innerHTML = ORIENTACIONES.map(o => `<option value="${o.id}" ${o.id===state.orientacion?"selected":""}>${o.nombre}</option>`).join("");
  }

  function renderPanel(state) {
    state = normalizeState(state);
    // derivar contadores desde checklist CPC/CPO
    state.blancas = (state.aprobadas_cpc || []).length;
    state.negritas = (state.aprobadas_cpo || []).length;
    const approvedSet = new Set(state.aprobadas || []);
    const approvedPoints = (DB.catalog.puntos || []).filter(m => approvedSet.has(m.id)).reduce((a,m) => a + (m.points ?? pointsByType(m.type)), 0);
    const totalPts = (state.puntosPrevios || 0) + approvedPoints;
    const faltan69 = Math.max(0, 69 - totalPts);
    const puedeEmpezarPuntos = state.blancas >= (DB.rules.eligibility.start_points_min_blancas ?? 12);
    const idiomaRule = DB.rules.eligibility.idioma;
    const practicaRule = DB.rules.eligibility.practica;
    const puedeIdioma = (state.negritas >= idiomaRule.min_negritas) && (state.blancas >= 14);
    const puedePractica = (state.blancas >= practicaRule.min_blancas) && (state.negritas >= practicaRule.min_negritas) && (totalPts >= practicaRule.min_points);
    const pill = (cls, txt) => `<span class="pill ${cls}">${txt}</span>`;

    document.getElementById("panel").innerHTML = `
      <div style="margin-bottom:10px;">
        <div><b>Puntos acumulados:</b> ${totalPts}</div>
        <div><b>Faltan para 69:</b> ${faltan69}</div>
      </div>
      <div style="margin-bottom:10px;">
        ${pill(puedeEmpezarPuntos ? "ok":"warn", puedeEmpezarPuntos ? "Podés empezar puntos" : `Aún no: necesitás ${DB.rules.eligibility.start_points_min_blancas ?? 12} blancas`)}
        ${pill(puedeIdioma ? "ok":"warn", puedeIdioma ? "Idioma habilitable" : "Idioma: todas blancas + 3 negritas")}
        ${pill(puedePractica ? "ok":"warn", puedePractica ? "Práctica habilitable" : "Práctica: 14 blancas + 5 negritas + 20 pts")}
      </div>
      <div class="muted small">
        <div><b>Aprobadas cargadas (1x1):</b> ${approvedSet.size} materia(s) de puntos</div>
        <div><b>Puntos previos:</b> ${state.puntosPrevios || 0}</div>
      </div>
    `;

    document.getElementById("rulesBox").innerHTML = `
      <b>Reglas base:</b>
      <div class="small muted">
        Mensual=${DB.rules.points.mensual},
        Bimestral=${DB.rules.points.bimestral},
        Cuatrimestral=${DB.rules.points.cuatrimestral}.<br>
        Límite cuatrimestre: ${DB.rules.limits.max_points_per_cuatrimestre} 
        pts. Límite bimestre: ${DB.rules.limits.max_points_per_bimestre} pts.
      </div>
    `;
  }

  function plannedAreas() {
    const lower = new Set();
    for (const id of PLAN) {
      const m = DB.catalog.puntos.find(x => x.id === id);
      if (m?.area) lower.add(m.area.toLowerCase());
    }
    return lower;
  }

  function renderPlanBox() {
    const state = loadState();
    const maxCuatri = DB.rules.limits.max_points_per_cuatrimestre ?? 16;
    const maxBim = DB.rules.limits.max_points_per_bimestre ?? 8;
    const materias = PLAN.map(id => DB.catalog.puntos.find(x => x.id === id)).filter(Boolean);
    const total = materias.reduce((a,m)=>a+(m.points ?? pointsByType(m.type)),0);

    const warn = [];
    if (total > maxCuatri) warn.push(`Supera ${maxCuatri} pts (cuatrimestre).`);
    const bims = materias.filter(m=>m.type==="bimestral").reduce((a,m)=>a+(m.points ?? 2),0);
    if (bims > maxBim) warn.push(`Bimestrales suman ${bims} pts (tope ${maxBim}).`);

    const areas = {};
    for (const m of materias) {
      if (!m.area) continue;
      const k = m.area.toLowerCase();
      areas[k] = (areas[k] || 0) + 1;
    }
    const reps = Object.entries(areas).filter(([,n])=>n>1).map(([k,n])=>`${k.toUpperCase()} x${n}`);
    if (reps.length) warn.push(`Áreas repetidas: ${reps.join(", ")}.`);

    document.getElementById("planBox").innerHTML = `
      <div class="small">
        <div><b>Materias en tu plan:</b> ${materias.length} — <b>Total:</b> ${total} pts</div>
        ${warn.length ? `<div class="pill warn">${esc(warn.join(" "))}</div>` : `<div class="pill ok">Plan OK (validación básica)</div>`}
      </div>
      <table>
        <thead><tr><th>Materia</th><th>Pts</th><th>Área</th><th></th></tr></thead>
        <tbody>
          ${materias.map(m=>`
            <tr>
              <td>${esc(m.name)}</td>
              <td>${m.points ?? pointsByType(m.type)}</td>
              <td>${esc(m.area || "")}</td>
              <td><button data-rm="${esc(m.id)}">Quitar</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    document.querySelectorAll("button[data-rm]").forEach(btn=>{
      btn.addEventListener("click", ()=> {
        const id = btn.getAttribute("data-rm");
        PLAN = PLAN.filter(x=>x!==id);
        renderPlanBox();
        renderCatalog();
      });
    });
  }

  function matchesFilters(m, q, depto, tipo, pts) {
    if (q) {
      const s = (m.name + " " + (m.area||"") + " " + (m.depto||"")).toLowerCase();
      if (!s.includes(q.toLowerCase())) return false;
    }
    if (depto && m.depto !== depto) return false;
    if (tipo && m.type !== tipo) return false;
    if (pts && String(m.points ?? pointsByType(m.type)) !== String(pts)) return false;
    return true;
  }

  function renderCatalog() {
    const state = loadState();
    const approvedSet = new Set(state.aprobadas || []);
    const plannedAreaSet = plannedAreas();

    const q = document.getElementById("q").value.trim();
    const depto = document.getElementById("f_depto").value;
    const tipo = document.getElementById("f_tipo").value;
    const pts = document.getElementById("f_pts").value;

    const rows = (DB.catalog.puntos || [])
      .filter(m => matchesFilters(m, q, depto, tipo, pts))
      .map(m => {
        const elig = evalMateriaEligibility(state, m, approvedSet, plannedAreaSet);
        const status = elig.ok
          ? `<span class="pill ok">Podés cursar</span>`
          : `<span class="pill bad">No</span> <span class="pill warn">${esc(elig.reasons.join(" · "))}</span>`;

        const prereq = (m.prerequisites || []).map(id => {
          const ref = DB.catalog.puntos.find(x=>x.id===id);
          return ref ? ref.name : id;
        });

        const alreadyInPlan = PLAN.includes(m.id);

        return `
          <tr>
            <td><b>${esc(m.name)}</b><br><span class="muted small mono">${esc(m.id)}</span></td>
            <td>${esc(m.depto || "")}</td>
            <td>${esc(m.type || "")}</td>
            <td>${m.points ?? pointsByType(m.type)}</td>
            <td>${esc(m.area || "")}</td>
            <td class="small">${esc(prereq.join(", "))}</td>
            <td>${status}</td>
            <td><button data-add="${esc(m.id)}" ${alreadyInPlan ? "disabled":""}>Agregar a plan</button></td>
          </tr>
        `;
      });

    document.getElementById("catalogRows").innerHTML = rows.join("");
    document.getElementById("resultCount").textContent = `${rows.length} resultado(s)`;

    document.querySelectorAll("button[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=> {
        const id = btn.getAttribute("data-add");
        if (!PLAN.includes(id)) PLAN.push(id);
        renderPlanBox();
        renderCatalog();
      });
    });
  }

  function suggestPlan() {
    const state = loadState();
    const maxCuatri = DB.rules.limits.max_points_per_cuatrimestre ?? 16;
    const approvedSet = new Set(state.aprobadas || []);
    const current = [];
    const areaSet = new Set();

    const candidates = (DB.catalog.puntos || [])
      .filter(m => m.plan.includes(state.plan))
      .map(m => ({ m, pts: (m.points ?? pointsByType(m.type)) }))
      .sort((a,b)=> b.pts - a.pts);

    let total = 0;
    for (const c of candidates) {
      const plannedAreaSet = new Set(areaSet);
      const elig = evalMateriaEligibility(state, c.m, approvedSet, plannedAreaSet);
      if (!elig.ok) continue;
      if (c.m.area && areaSet.has(c.m.area.toLowerCase())) continue;

      if (total + c.pts <= maxCuatri) {
        current.push(c.m.id);
        total += c.pts;
        if (c.m.area) areaSet.add(c.m.area.toLowerCase());
      }
      if (total === maxCuatri) break;
    }
    PLAN = current;
    renderPlanBox();
    renderCatalog();
  }

  function wireSearch() {
    ["q","f_depto","f_tipo","f_pts"].forEach(id=>{
      document.getElementById(id).addEventListener("input", renderCatalog);
      document.getElementById(id).addEventListener("change", renderCatalog);
    });
  }

  async function initApp() {
    const res = await fetch("./materias.json", { cache: "no-store" });
    DB = await res.json();

    // Cargar materias desde Google Sheets
    const rMat = await listMaterias();
    if (!rMat.ok) throw new Error(rMat.error || "No pude listar materias desde Sheets");
    MAT_SHEET = rMat.materias || [];

    const state = normalizeState(loadState());
    renderSelectors(state);
    document.getElementById("plan").value = state.plan;
    document.getElementById("orientacion").value = state.orientacion;
    document.getElementById("puntosPrevios").value = state.puntosPrevios || 0;

    // Inicializar dual lists CPC/CPO
    wireDualList(2, "cpc_pending", "cpc_approved", "cpc_to_approved", "cpc_to_pending", "aprobadas_cpc");
    wireDualList(3, "cpo_pending", "cpo_approved", "cpo_to_approved", "cpo_to_pending", "aprobadas_cpo");

    renderPanel(state);
    renderPlanBox();
    renderCatalog();
    wireSearch();

    document.getElementById("save").addEventListener("click", async () => {
      const s = normalizeState(loadState());
      s.plan = document.getElementById("plan").value;
      s.orientacion = document.getElementById("orientacion").value;
      s.puntosPrevios = Number(document.getElementById("puntosPrevios").value || 0);
      readDualListsIntoState(s);
      saveState(s);

      // Guardar progreso en Sheets (multi-dispositivo)
      const sess = getSession();
      if (sess?.usuario_id) {
        const progreso = {
          plan: s.plan,
          orientacion: s.orientacion,
          puntosPrevios: s.puntosPrevios,
          aprobadas_cpc: s.aprobadas_cpc,
          aprobadas_cpo: s.aprobadas_cpo,
          aprobadas_puntos: s.aprobadas || []
        };
        const r = await saveProgress(Number(sess.usuario_id), progreso);
        if (!r.ok) console.warn("save_progress:", r);
      }

      saveState(s);
      renderSelectors(s);
      renderPanel(s);
      renderPlanBox();
      renderCatalog();
    });

    document.getElementById("reset").addEventListener("click", () => {
      localStorage.removeItem(KEY);
      PLAN = [];
      location.reload();
    });

    document.getElementById("btnSuggest").addEventListener("click", suggestPlan);
  }

  function showAuth(msg="") {
    document.getElementById("authGate").style.display = "block";
    document.getElementById("appRoot").style.display = "none";
    document.getElementById("authMsg").textContent = msg;
  }
  function showApp(username) {
    document.getElementById("authGate").style.display = "none";
    document.getElementById("appRoot").style.display = "block";
    document.getElementById("whoami").textContent = username ? `@${username}` : "";
  }

  document.getElementById("btnLogout").addEventListener("click", () => { clearSession(); location.reload(); });

  document.getElementById("btnLogin").addEventListener("click", async (e) => {
    e.preventDefault();
    const u = document.getElementById("authUser").value;
    const p = document.getElementById("authPass").value;
    const r = await loginUser(u, p);
    if (!r.ok) return showAuth(r.error || "Login falló.");
    setSession(u.trim(), r.usuario_id);
    showApp(u.trim());
    // Cargar progreso desde Sheets (si existe) y guardarlo localmente
    if (r.usuario_id) {
      const rp = await loadProgress(Number(r.usuario_id));
      if (rp.ok && rp.progreso) {
        const local = normalizeState(loadState());
        const merged = { ...local, ...rp.progreso };
        // compat: nombres esperados por app
        if (Array.isArray(merged.aprobadas_puntos)) merged.aprobadas = merged.aprobadas_puntos;
        saveState(merged);
      }
    }
    await initApp();
  });

  document.getElementById("btnRegister").addEventListener("click", async (e) => {
    e.preventDefault();
    const u = document.getElementById("authUser").value;
    const p = document.getElementById("authPass").value;
    const r = await registerUser(u, p);
    if (!r.ok) return showAuth(r.error || "Registro falló.");
    setSession(u.trim(), r.usuario_id);
    showApp(u.trim());
    // Cargar progreso desde Sheets (si existe) y guardarlo localmente
    if (r.usuario_id) {
      const rp = await loadProgress(Number(r.usuario_id));
      if (rp.ok && rp.progreso) {
        const local = normalizeState(loadState());
        const merged = { ...local, ...rp.progreso };
        // compat: nombres esperados por app
        if (Array.isArray(merged.aprobadas_puntos)) merged.aprobadas = merged.aprobadas_puntos;
        saveState(merged);
      }
    }
    await initApp();
  });

  (async function boot(){
    try {
      const s = getSession();
      if (s?.username) {
        showApp(s.username);
        if (s.usuario_id) {
          const rp = await loadProgress(Number(s.usuario_id));
          if (rp.ok && rp.progreso) {
            const local = normalizeState(loadState());
            const merged = { ...local, ...rp.progreso };
            if (Array.isArray(merged.aprobadas_puntos)) merged.aprobadas = merged.aprobadas_puntos;
            saveState(merged);
          }
        }
        await initApp();
      }
      else { showAuth(""); }
    } catch (e) {
      console.error(e);
      showError("Error iniciando la app: " + e.message);
    }

  })();
</script>
  </div>
</body>
</html>
